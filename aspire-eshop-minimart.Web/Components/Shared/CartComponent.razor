@using aspire_eshop_minimart.Web.Services
@inject CartService CartService
@inject NavigationManager Navigation
@rendermode InteractiveServer
@implements IDisposable

<MudBadge Content="@itemCount" 
          Color="Color.Error" 
          Visible="@(itemCount > 0)" 
          Overlap="true" 
          Class="mx-2">
    <MudIconButton Icon="@Icons.Material.Filled.ShoppingCart" 
                   Color="Color.Inherit" 
                   OnClick="NavigateToCart"
                   Size="Size.Medium" />
</MudBadge>

@code {
    private int itemCount = 0;

    protected override async Task OnInitializedAsync()
    {
        CartService.OnCartChanged += HandleCartChanged;
        await UpdateCartCount();
    }

    private async Task UpdateCartCount()
    {
        try
        {
            itemCount = await CartService.GetCartItemCountAsync();
        }
        catch
        {
            itemCount = 0;
        }
    }

    private void NavigateToCart()
    {
        Navigation.NavigateTo("/cart");
    }

    private async void HandleCartChanged()
    {
        await InvokeAsync(async () =>
        {
            await UpdateCartCount();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        CartService.OnCartChanged -= HandleCartChanged;
    }
}